<!DOCTYPE html>
<html>
<head>
  <title>MeChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #e5ddd5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: #4CAF50;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }

    .section {
      background: white;
      padding: 15px;
      border-bottom: 1px solid #ddd;
    }

    .user-item {
      padding: 10px;
      margin-bottom: 8px;
      background: #f1f1f1;
      border-radius: 8px;
      cursor: pointer;
    }

    .user-item:hover {
      background: #e0e0e0;
    }

    #chatSection {
      flex: 1;
      display: none;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 14px;
      font-size: 14px;
      word-wrap: break-word;
    }

    .sent {
      background: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .received {
      background: white;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .meta {
      font-size: 10px;
      margin-top: 4px;
      text-align: right;
      color: #555;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #ccc;
    }

    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }

    #sendBtn {
      margin-left: 8px;
      background: #4CAF50;
      color: white;
      border-radius: 20px;
      border: none;
      padding: 8px 15px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<header>
  üîê MeChat
  <button onclick="logout()">Logout</button>
</header>

<div class="section">
  <h3>Your Chats</h3>
  <div id="chatsContainer"></div>
</div>

<div class="section">
  <h3>Start New Chat</h3>
  <div id="usersContainer"></div>
</div>

<div id="chatSection">
  <div id="messages"></div>

  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Type message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  setDoc,
  getDoc,
  getDocs,
  query,
  where,
  onSnapshot,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGBti5osQ56y6jnqR4cYbKvfJwCd_QGFw",
  authDomain: "mechat-99b43.firebaseapp.com",
  projectId: "mechat-99b43",
  storageBucket: "mechat-99b43.firebasestorage.app",
  messagingSenderId: "779239079350",
  appId: "1:779239079350:web:b3d2d55d5d8d39220d1517"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;
let currentChatId = null;
let unsubscribeMessages = null;

// Simple encryption
function encrypt(text) {
  return btoa(text);
}

function decrypt(text) {
  return atob(text);
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  currentUser = user;

  loadChats();
  loadUsers();
});

window.logout = function() {
  signOut(auth);
};

// LOAD EXISTING CHATS
function loadChats() {
  const chatsContainer = document.getElementById("chatsContainer");

  const q = query(
    collection(db, "chats"),
    where("participants", "array-contains", currentUser.uid)
  );

  onSnapshot(q, async (snapshot) => {
    chatsContainer.innerHTML = "";

    for (const docSnap of snapshot.docs) {
      const chatId = docSnap.id;
      const participants = docSnap.data().participants;
      const otherUserId = participants.find(p => p !== currentUser.uid);

      const userDoc = await getDoc(doc(db, "users", otherUserId));
      let username = otherUserId;

      if (userDoc.exists()) {
        username = userDoc.data().username;
      }

      const div = document.createElement("div");
      div.className = "user-item";
      div.textContent = username;

      div.onclick = () => {
        currentChatId = chatId;
        openChat();
      };

      chatsContainer.appendChild(div);
    }
  });
}

// LOAD USERS WITHOUT CHAT
async function loadUsers() {
  const usersContainer = document.getElementById("usersContainer");
  usersContainer.innerHTML = "";

  const chatSnapshot = await getDocs(
    query(collection(db, "chats"),
    where("participants", "array-contains", currentUser.uid))
  );

  const existingChatUsers = new Set();

  chatSnapshot.forEach(docSnap => {
    const participants = docSnap.data().participants;
    const otherUser = participants.find(p => p !== currentUser.uid);
    existingChatUsers.add(otherUser);
  });

  const snapshot = await getDocs(collection(db, "users"));

  snapshot.forEach(docSnap => {
    if (docSnap.id !== currentUser.uid && !existingChatUsers.has(docSnap.id)) {
      const user = docSnap.data();

      const div = document.createElement("div");
      div.className = "user-item";
      div.textContent = user.username;

      div.onclick = () => startChat(docSnap.id);

      usersContainer.appendChild(div);
    }
  });
}

// START CHAT
async function startChat(userId) {
  const chatId = [currentUser.uid, userId].sort().join("_");
  currentChatId = chatId;

  await setDoc(doc(db, "chats", chatId), {
    participants: [currentUser.uid, userId],
    lastUpdated: serverTimestamp()
  }, { merge: true });

  openChat();
}

// OPEN CHAT
function openChat() {
  if (!currentChatId) return;

  document.getElementById("chatSection").style.display = "flex";
  const messagesDiv = document.getElementById("messages");

  if (unsubscribeMessages) unsubscribeMessages();

  const q = query(
    collection(db, "chats", currentChatId, "messages"),
    orderBy("timestamp")
  );

  unsubscribeMessages = onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = "";

    snapshot.forEach(docSnap => {
      const msg = docSnap.data();

      if (!msg.timestamp) return;

      if (msg.senderId !== currentUser.uid && !msg.seen) {
        setDoc(doc(db, "chats", currentChatId, "messages", docSnap.id), {
          seen: true
        }, { merge: true });
      }

      const div = document.createElement("div");
      div.classList.add("message");

      if (msg.senderId === currentUser.uid) {
        div.classList.add("sent");
      } else {
        div.classList.add("received");
      }

      const text = decrypt(msg.text);
      const time = msg.timestamp.toDate().toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });

      div.innerHTML = `
        <div>${text}</div>
        <div class="meta">
          ${time}
          ${msg.senderId === currentUser.uid ? (msg.seen ? " ‚úî‚úî" : " ‚úî") : ""}
        </div>
      `;

      messagesDiv.appendChild(div);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// SEND MESSAGE
document.getElementById("sendBtn").onclick = async () => {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();

  if (!text || !currentChatId) return;

  await addDoc(collection(db, "chats", currentChatId, "messages"), {
    senderId: currentUser.uid,
    text: encrypt(text),
    timestamp: serverTimestamp(),
    seen: false
  });

  await setDoc(doc(db, "chats", currentChatId), {
    lastUpdated: serverTimestamp()
  }, { merge: true });

  input.value = "";
};

</script>

</body>
</html>
