<!DOCTYPE html>
<html>
<head>
  <title>MeChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f0f2f5;
    }

    .header {
      background: #075E54;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header button {
      background: none;
      border: none;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    .container {
      padding: 15px;
      padding-bottom: 120px;
    }

    .section-title {
      font-weight: 600;
      margin: 20px 0 10px;
      font-size: 16px;
      color: #444;
    }

    .chat-item {
      background: white;
      padding: 12px 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      cursor: pointer;
      position: relative;
    }

    .chat-username {
      font-weight: 600;
      font-size: 15px;
    }

    .chat-preview {
      font-size: 13px;
      color: gray;
      margin-top: 3px;
    }

    .badge {
      position: absolute;
      right: 15px;
      top: 18px;
      background: #25D366;
      color: white;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 20px;
    }

    .search-bar {
      display: flex;
      gap: 8px;
    }

    .search-bar input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 25px;
      border: 1px solid #ddd;
      outline: none;
    }

    .search-bar button {
      padding: 10px 15px;
      border-radius: 25px;
      border: none;
      background: #25D366;
      color: white;
      cursor: pointer;
    }

    .chat-window {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #efeae2;
      height: 55%;
      display: none;
      flex-direction: column;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .chat-header {
      padding: 12px 15px;
      background: #075E54;
      color: white;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      font-weight: 600;
    }

    .chat-box {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 15px;
      margin: 6px 0;
      font-size: 14px;
      clear: both;
    }

    .sent {
      background: #dcf8c6;
      float: right;
      border-bottom-right-radius: 3px;
    }

    .received {
      background: white;
      float: left;
      border-bottom-left-radius: 3px;
    }

    .input-area {
      display: flex;
      padding: 10px;
      background: white;
      gap: 8px;
    }

    .input-area input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 25px;
      border: 1px solid #ddd;
      outline: none;
    }

    .input-area button {
      background: #25D366;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 25px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<div class="header">
  ðŸ”’ MeChat
  <button onclick="logout()">Logout</button>
</div>

<div class="container">

  <div class="section-title">Your Chats</div>
  <div id="chatList"></div>

  <div class="section-title">Start New Chat</div>
  <div class="search-bar">
    <input type="text" id="searchUser" placeholder="Enter username">
    <button onclick="searchUser()">Search</button>
  </div>
  <div id="searchResult"></div>

</div>

<!-- CHAT WINDOW -->
<div class="chat-window" id="chatWindow">
  <div class="chat-header" id="chatWith"></div>
  <div class="chat-box" id="chatBox"></div>
  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Type message...">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBGBti5osQ56y6jnqR4cYbKvfJwCd_QGFw",
  authDomain: "mechat-99b43.firebaseapp.com",
  projectId: "mechat-99b43",
  storageBucket: "mechat-99b43.firebasestorage.app",
  messagingSenderId: "779239079350",
  appId: "1:779239079350:web:b3d2d55d5d8d39220d1517"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;
let currentChatId;
let otherUserId;

auth.onAuthStateChanged(user=>{
  if(!user) window.location="index.html";
  currentUser=user;
  loadChats();
});

function logout(){ auth.signOut(); }

function loadChats(){
  db.collection("chats")
    .where("participants","array-contains",currentUser.uid)
    .orderBy("lastTimestamp","desc")
    .onSnapshot(snapshot=>{
      const list=document.getElementById("chatList");
      list.innerHTML="";
      snapshot.forEach(doc=>{
        const data=doc.data();
        const other=data.participants.find(p=>p!==currentUser.uid);
        const unread=data.unreadCount?.[currentUser.uid]||0;

        db.collection("users").doc(other).get().then(u=>{
          const div=document.createElement("div");
          div.className="chat-item";
          div.innerHTML=`
            <div class="chat-username">${u.data()?.username||"User"}</div>
            <div class="chat-preview">${data.lastMessage||""}</div>
            ${unread>0?`<div class="badge">${unread}</div>`:""}
          `;
          div.onclick=()=>openChat(doc.id,other,u.data()?.username);
          list.appendChild(div);
        });
      });
    });
}

function searchUser(){
  const username=document.getElementById("searchUser").value.trim();
  if(!username)return;

  db.collection("users").where("username","==",username).get()
  .then(snap=>{
    const result=document.getElementById("searchResult");
    result.innerHTML="";
    snap.forEach(doc=>{
      if(doc.id===currentUser.uid)return;
      const div=document.createElement("div");
      div.className="chat-item";
      div.innerHTML=`<div class="chat-username">${username}</div>`;
      div.onclick=()=>createOrOpenChat(doc.id,username);
      result.appendChild(div);
    });
  });
}

function createOrOpenChat(uid,username){
  const chatId=[currentUser.uid,uid].sort().join("_");
  db.collection("chats").doc(chatId).set({
    participants:[currentUser.uid,uid],
    lastMessage:"",
    lastTimestamp:firebase.firestore.FieldValue.serverTimestamp(),
    unreadCount:{[currentUser.uid]:0,[uid]:0}
  },{merge:true}).then(()=>{
    openChat(chatId,uid,username);
  });
}

function openChat(chatId,uid,username){
  currentChatId=chatId;
  otherUserId=uid;
  document.getElementById("chatWindow").style.display="flex";
  document.getElementById("chatWith").innerText=username;

  db.collection("chats").doc(chatId).update({
    ["unreadCount."+currentUser.uid]:0
  });

  db.collection("chats").doc(chatId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{
      const box=document.getElementById("chatBox");
      box.innerHTML="";
      snapshot.forEach(doc=>{
        const m=doc.data();
        const div=document.createElement("div");
        div.className="message "+(m.sender===currentUser.uid?"sent":"received");
        div.innerText=m.text;
        box.appendChild(div);
      });
      box.scrollTop=box.scrollHeight;
    });
}

function sendMessage(){
  const input=document.getElementById("messageInput");
  const text=input.value.trim();
  if(!text)return;

  const ref=db.collection("chats").doc(currentChatId);

  ref.collection("messages").add({
    text:text,
    sender:currentUser.uid,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });

  ref.update({
    lastMessage:text,
    lastTimestamp:firebase.firestore.FieldValue.serverTimestamp(),
    ["unreadCount."+otherUserId]:firebase.firestore.FieldValue.increment(1),
    ["unreadCount."+currentUser.uid]:0
  });

  input.value="";
}
</script>

</body>
</html>
