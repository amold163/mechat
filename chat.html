<!DOCTYPE html>
<html>
<head>
  <title>MeChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    body { font-family: Arial; margin: 0; background: #f2f2f2; }
    .header {
      background: #4CAF50;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .container { padding: 15px; }
    .section-title { font-size: 20px; margin-top: 20px; }

    .chat-item {
      background: #ddd;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      cursor: pointer;
      position: relative;
    }

    .badge {
      background: red;
      color: white;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 20px;
      position: absolute;
      right: 10px;
      top: 10px;
    }

    .search-bar {
      display: flex;
      margin-top: 10px;
    }

    .search-bar input {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }

    .search-bar button {
      margin-left: 10px;
      padding: 10px 15px;
      border-radius: 20px;
      border: none;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }

    .chat-box {
      background: #e5ddd5;
      padding: 10px;
      border-radius: 10px;
      margin-top: 15px;
      height: 300px;
      overflow-y: auto;
    }

    .message {
      max-width: 70%;
      padding: 8px;
      margin: 5px 0;
      border-radius: 10px;
      clear: both;
    }

    .sent {
      background: #dcf8c6;
      float: right;
    }

    .received {
      background: white;
      float: left;
    }

    .input-area {
      display: flex;
      margin-top: 10px;
    }

    .input-area input {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }

    .input-area button {
      margin-left: 10px;
      padding: 10px 15px;
      border-radius: 20px;
      border: none;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
  </style>
</head>

<body>

<div class="header">
  <div>ðŸ”’ MeChat</div>
  <button onclick="logout()">Logout</button>
</div>

<div class="container">

  <div class="section-title">Your Chats</div>
  <div id="chatList"></div>

  <div class="section-title">Start New Chat</div>
  <div class="search-bar">
    <input type="text" id="searchUser" placeholder="Enter username">
    <button onclick="searchUser()">Search</button>
  </div>
  <div id="searchResult"></div>

  <div id="activeChatSection" style="display:none;">
    <h3 id="chatWith"></h3>
    <div class="chat-box" id="chatBox"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBGBti5osQ56y6jnqR4cYbKvfJwCd_QGFw",
  authDomain: "mechat-99b43.firebaseapp.com",
  projectId: "mechat-99b43",
  storageBucket: "mechat-99b43.firebasestorage.app",
  messagingSenderId: "779239079350",
  appId: "1:779239079350:web:b3d2d55d5d8d39220d1517"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;
let currentChatId = null;
let otherUserId = null;

auth.onAuthStateChanged(user => {
  if (!user) window.location.href = "index.html";
  currentUser = user;
  loadChats();
});

function logout(){
  auth.signOut();
}

function loadChats(){
  db.collection("chats")
    .where("participants", "array-contains", currentUser.uid)
    .orderBy("lastTimestamp", "desc")
    .onSnapshot(snapshot => {
      const chatList = document.getElementById("chatList");
      chatList.innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        const other = data.participants.find(uid => uid !== currentUser.uid);
        const unread = data.unreadCount?.[currentUser.uid] || 0;

        db.collection("users").doc(other).get().then(userDoc => {
          const username = userDoc.data()?.username || "User";

          const div = document.createElement("div");
          div.className = "chat-item";
          div.innerHTML = username + 
            (unread > 0 ? `<span class="badge">${unread}</span>` : "");
          div.onclick = () => openChat(doc.id, other, username);
          chatList.appendChild(div);
        });
      });
    });
}

function searchUser(){
  const username = document.getElementById("searchUser").value.trim();
  if(!username) return;

  db.collection("users")
    .where("username", "==", username)
    .get()
    .then(snapshot => {
      const resultDiv = document.getElementById("searchResult");
      resultDiv.innerHTML = "";

      snapshot.forEach(doc => {
        if(doc.id === currentUser.uid) return;

        const div = document.createElement("div");
        div.className = "chat-item";
        div.innerText = username;
        div.onclick = () => createOrOpenChat(doc.id, username);
        resultDiv.appendChild(div);
      });
    });
}

function createOrOpenChat(userId, username){
  const chatId = [currentUser.uid, userId].sort().join("_");

  db.collection("chats").doc(chatId).get().then(doc => {
    if(!doc.exists){
      db.collection("chats").doc(chatId).set({
        participants: [currentUser.uid, userId],
        lastMessage: "",
        lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
        unreadCount: {
          [currentUser.uid]: 0,
          [userId]: 0
        }
      });
    }
    openChat(chatId, userId, username);
  });
}

function openChat(chatId, userId, username){
  currentChatId = chatId;
  otherUserId = userId;
  document.getElementById("chatWith").innerText = username;
  document.getElementById("activeChatSection").style.display = "block";

  db.collection("chats").doc(chatId).update({
    ["unreadCount."+currentUser.uid]: 0
  });

  db.collection("chats").doc(chatId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot => {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.className = "message " + 
          (msg.sender === currentUser.uid ? "sent" : "received");
        div.innerText = msg.text;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
}

function sendMessage(){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(!text || !currentChatId) return;

  const chatRef = db.collection("chats").doc(currentChatId);

  chatRef.collection("messages").add({
    text: text,
    sender: currentUser.uid,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  chatRef.update({
    lastMessage: text,
    lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
    ["unreadCount."+otherUserId]:
      firebase.firestore.FieldValue.increment(1),
    ["unreadCount."+currentUser.uid]: 0
  });

  input.value = "";
}
</script>

</body>
</html>
