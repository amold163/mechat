<!DOCTYPE html>
<html>
<head>
  <title>MeChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #e5ddd5;
    }

    header {
      background: #4CAF50;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }

    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #chatList, #userList {
      padding: 15px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }

    .user-item {
      padding: 10px;
      border-radius: 8px;
      background: #f1f1f1;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .user-item:hover {
      background: #e0e0e0;
    }

    #messages {
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 14px;
      word-wrap: break-word;
      font-size: 14px;
    }

    .sent {
      background: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .received {
      background: #ffffff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .meta {
      font-size: 10px;
      color: #555;
      margin-top: 4px;
      text-align: right;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ccc;
    }

    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }

    #sendBtn {
      background: #4CAF50;
      color: white;
      margin-left: 8px;
      border-radius: 20px;
    }

  </style>
</head>
<body>

<header>
  üîê MeChat
  <button onclick="logout()">Logout</button>
</header>

<div id="chatList">
  <h3>Your Chats</h3>
  <div id="chatsContainer"></div>
</div>

<div id="userList">
  <h3>Start New Chat</h3>
  <div id="usersContainer"></div>
</div>

<div id="chatSection" style="display:none;">
  <h3 id="chatTitle" style="padding:10px;"></h3>

  <div id="messages"></div>

  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Type message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGBti5osQ56y6jnqR4cYbKvfJwCd_QGFw",
  authDomain: "mechat-99b43.firebaseapp.com",
  projectId: "mechat-99b43",
  storageBucket: "mechat-99b43.firebasestorage.app",
  messagingSenderId: "779239079350",
  appId: "1:779239079350:web:b3d2d55d5d8d39220d1517"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;
let currentChatId = null;
let currentChatUser = null;

const SECRET_KEY = "mechat-secret";

// Encryption
function encrypt(text) {
  return btoa(text);
}

function decrypt(text) {
  return atob(text);
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  currentUser = user;

  loadUsers();
  loadChats();
});

window.logout = function() {
  signOut(auth);
};

// Load users
async function loadUsers() {
  const usersContainer = document.getElementById("usersContainer");
  usersContainer.innerHTML = "";

  const snapshot = await getDocs(collection(db, "users"));

  snapshot.forEach(docSnap => {
    const user = docSnap.data();

    if (docSnap.id !== currentUser.uid) {
      const div = document.createElement("div");
      div.className = "user-item";
      div.textContent = user.username;
      div.onclick = () => startChat(docSnap.id, user.username);
      usersContainer.appendChild(div);
    }
  });
}

// Start chat
async function startChat(userId, username) {
  const chatId = [currentUser.uid, userId].sort().join("_");
  currentChatId = chatId;
  currentChatUser = username;

  await setDoc(doc(db, "chats", chatId), {
    participants: [currentUser.uid, userId],
    lastUpdated: new Date()
  }, { merge: true });

  openChat();
}

// Load chats list
function loadChats() {
  const chatsContainer = document.getElementById("chatsContainer");

  const q = query(
    collection(db, "chats"),
    where("participants", "array-contains", currentUser.uid),
    orderBy("lastUpdated", "desc")
  );

  onSnapshot(q, snapshot => {
    chatsContainer.innerHTML = "";

    snapshot.forEach(docSnap => {
      const chatId = docSnap.id;
      const participants = docSnap.data().participants;
      const otherUser = participants.find(p => p !== currentUser.uid);

      const div = document.createElement("div");
      div.className = "user-item";
      div.textContent = "Chat with " + otherUser;
      div.onclick = () => {
        currentChatId = chatId;
        openChat();
      };
      chatsContainer.appendChild(div);
    });
  });
}

// Open chat
function openChat() {
  document.getElementById("chatSection").style.display = "block";
  document.getElementById("messages").innerHTML = "";

  const messagesDiv = document.getElementById("messages");

  const q = query(
    collection(db, "chats", currentChatId, "messages"),
    orderBy("timestamp")
  );

  onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = "";

    snapshot.forEach(docSnap => {
      const msg = docSnap.data();

      if (msg.senderId !== currentUser.uid && !msg.seen) {
        setDoc(doc(db, "chats", currentChatId, "messages", docSnap.id), {
          seen: true
        }, { merge: true });
      }

      const div = document.createElement("div");
      div.classList.add("message");

      if (msg.senderId === currentUser.uid) {
        div.classList.add("sent");
      } else {
        div.classList.add("received");
      }

      const text = decrypt(msg.text);

      const time = msg.timestamp
        ? new Date(msg.timestamp.seconds * 1000)
            .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : "";

      div.innerHTML = `
        <div>${text}</div>
        <div class="meta">
          ${time}
          ${msg.senderId === currentUser.uid 
            ? (msg.seen ? " ‚úî‚úî" : " ‚úî") 
            : ""}
        </div>
      `;

      messagesDiv.appendChild(div);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// Send message
document.getElementById("sendBtn").onclick = async () => {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();

  if (!text || !currentChatId) return;

  const encrypted = encrypt(text);

  await addDoc(collection(db, "chats", currentChatId, "messages"), {
    senderId: currentUser.uid,
    text: encrypted,
    timestamp: new Date(),
    seen: false
  });

  await setDoc(doc(db, "chats", currentChatId), {
    lastMessage: encrypted,
    lastUpdated: new Date()
  }, { merge: true });

  input.value = "";
};
</script>

</body>
</html>
