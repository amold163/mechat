<!DOCTYPE html>
<html>
<head>
  <title>MeChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #cfc4b8;
    }

    header {
      background: #4CAF50;
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .container {
      padding: 15px;
    }

    h2 {
      margin-top: 10px;
    }

    .chat-item {
      background: #eee;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    .chat-item:hover {
      background: #ddd;
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    input {
      flex: 1;
      padding: 12px;
      border-radius: 25px;
      border: none;
      outline: none;
    }

    button {
      padding: 12px 20px;
      border-radius: 25px;
      border: none;
      background: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #chatArea {
      margin-top: 20px;
      background: #bfae9f;
      border-radius: 15px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
    }

    .msg {
      padding: 10px 14px;
      border-radius: 15px;
      margin-bottom: 8px;
      max-width: 70%;
      font-size: 14px;
    }

    .sent {
      background: #d4f8c4;
      margin-left: auto;
    }

    .received {
      background: white;
      margin-right: auto;
    }

    .input-area {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<header>
  üîê MeChat
  <span style="cursor:pointer" onclick="logout()">Logout</span>
</header>

<div class="container">

  <h2>Your Chats</h2>
  <div id="chatList"></div>

  <h2>Start New Chat</h2>
  <div class="search-box">
    <input type="text" id="searchUser" placeholder="Enter username">
    <button onclick="searchUser()">Search</button>
  </div>

  <div id="searchResult"></div>

  <h2 id="chatTitle"></h2>
  <div id="chatArea"></div>

  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Type message...">
    <button onclick="sendMessage()">Send</button>
  </div>

</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBGBti5osQ56y6jnqR4cYbKvfJwCd_QGFw",
    authDomain: "mechat-99b43.firebaseapp.com",
    projectId: "mechat-99b43",
    storageBucket: "mechat-99b43.firebasestorage.app",
    messagingSenderId: "779239079350",
    appId: "1:779239079350:web:b3d2d55d5d8d39220d1517"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let currentUser;
  let currentChatId = null;
  let currentChatUser = null;

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      currentUser = user;
      loadChats();
    }
  });

  function logout() {
    auth.signOut();
  }

  async function loadChats() {
    db.collection("chats")
      .where("participants", "array-contains", currentUser.uid)
      .orderBy("lastUpdated", "desc")
      .onSnapshot(async snapshot => {

        const chatList = document.getElementById("chatList");
        chatList.innerHTML = "";

        for (const doc of snapshot.docs) {
          const chat = doc.data();
          const otherUid = chat.participants.find(p => p !== currentUser.uid);

          const userDoc = await db.collection("users").doc(otherUid).get();
          const username = userDoc.exists ? userDoc.data().username : "Unknown";

          const div = document.createElement("div");
          div.className = "chat-item";
          div.innerText = username;
          div.onclick = () => openChat(doc.id, username, otherUid);

          chatList.appendChild(div);
        }
      });
  }

  async function searchUser() {
    const username = document.getElementById("searchUser").value.trim();
    if (!username) return;

    const resultDiv = document.getElementById("searchResult");
    resultDiv.innerHTML = "";

    const query = await db.collection("users")
      .where("username", "==", username)
      .get();

    if (query.empty) {
      resultDiv.innerHTML = "<p>User not found</p>";
      return;
    }

    const userDoc = query.docs[0];
    const userData = userDoc.data();

    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerText = userData.username;
    div.onclick = () => createOrOpenChat(userDoc.id, userData.username);

    resultDiv.appendChild(div);
  }

  async function createOrOpenChat(otherUid, username) {

    const chats = await db.collection("chats")
      .where("participants", "array-contains", currentUser.uid)
      .get();

    for (const doc of chats.docs) {
      if (doc.data().participants.includes(otherUid)) {
        openChat(doc.id, username, otherUid);
        return;
      }
    }

    const newChat = await db.collection("chats").add({
      participants: [currentUser.uid, otherUid],
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });

    openChat(newChat.id, username, otherUid);
  }

  function openChat(chatId, username, otherUid) {
    currentChatId = chatId;
    currentChatUser = otherUid;
    document.getElementById("chatTitle").innerText = username;

    db.collection("chats")
      .doc(chatId)
      .collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {

        const chatArea = document.getElementById("chatArea");
        chatArea.innerHTML = "";

        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "msg " + (msg.sender === currentUser.uid ? "sent" : "received");
          div.innerText = msg.text;
          chatArea.appendChild(div);
        });

        chatArea.scrollTop = chatArea.scrollHeight;
      });
  }

  function sendMessage() {
    const text = document.getElementById("messageInput").value.trim();
    if (!text || !currentChatId) return;

    db.collection("chats")
      .doc(currentChatId)
      .collection("messages")
      .add({
        text: text,
        sender: currentUser.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    db.collection("chats").doc(currentChatId).update({
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("messageInput").value = "";
  }
</script>

</body>
</html>
