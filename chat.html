<!DOCTYPE html>
<html>
<head>
  <title>MeChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: #f4f4f4;
    }

    header {
      background: #4CAF50;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: #4CAF50;
      color: white;
    }

    .container {
      padding: 15px;
    }

    .chat-list div {
      background: #e0e0e0;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 10px;
      cursor: pointer;
    }

    .messages {
      height: 300px;
      overflow-y: auto;
      background: #ddd;
      padding: 10px;
      border-radius: 10px;
      margin-top: 10px;
    }

    .msg {
      max-width: 70%;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 10px;
      font-size: 14px;
    }

    .sent {
      background: #c8f7c5;
      margin-left: auto;
      text-align: right;
    }

    .received {
      background: #fff;
      margin-right: auto;
    }

    .input-box {
      display: flex;
      margin-top: 10px;
    }

    .input-box input {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }

    .input-box button {
      margin-left: 10px;
      border-radius: 20px;
    }
  </style>
</head>
<body>

<header>
  <div>ðŸ”’ MeChat</div>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

  <h2>Your Chats</h2>
  <div class="chat-list" id="chatList"></div>

  <h3>Start New Chat</h3>
  <div class="chat-list" id="userList"></div>

  <hr>

  <h3 id="chatWith"></h3>
  <div class="messages" id="messages"></div>

  <div class="input-box">
    <input type="text" id="messageInput" placeholder="Type message...">
    <button onclick="sendMessage()">Send</button>
  </div>

</div>

<script>
  // ðŸ”¥ YOUR FIREBASE CONFIG
  const firebaseConfig = {
  apiKey: "AIzaSyBGBti5osQ56y6jnqR4cYbKvfJwCd_QGFw",
  authDomain: "mechat-99b43.firebaseapp.com",
  projectId: "mechat-99b43",
  storageBucket: "mechat-99b43.firebasestorage.app",
  messagingSenderId: "779239079350",
  appId: "1:779239079350:web:b3d2d55d5d8d39220d1517"
};

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  const SECRET_KEY = "mechat-secret";

  let currentUser;
  let selectedUser = null;
  let unsubscribe = null;

  // SAFE DECRYPT
  function decrypt(text) {
    try {
      const bytes = CryptoJS.AES.decrypt(text, SECRET_KEY);
      const result = bytes.toString(CryptoJS.enc.Utf8);
      return result ? result : text;
    } catch {
      return text;
    }
  }

  function encrypt(text) {
    return CryptoJS.AES.encrypt(text, SECRET_KEY).toString();
  }

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      currentUser = user;
      loadUsers();
      loadChatList();
    }
  });

  function logout() {
    auth.signOut();
  }

  function getChatId(uid1, uid2) {
    return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
  }

  function loadUsers() {
    db.collection("users").get().then(snapshot => {
      const list = document.getElementById("userList");
      list.innerHTML = "";

      snapshot.forEach(doc => {
        if (doc.id !== currentUser.uid) {
          const div = document.createElement("div");
          div.innerText = doc.data().username;
          div.onclick = () => openChat(doc.id, doc.data().username);
          list.appendChild(div);
        }
      });
    });
  }

  function loadChatList() {
    db.collection("chats")
      .where("participants", "array-contains", currentUser.uid)
      .onSnapshot(snapshot => {

        const chatList = document.getElementById("chatList");
        chatList.innerHTML = "";

        snapshot.forEach(doc => {
          const data = doc.data();
          const otherId = data.participants.find(id => id !== currentUser.uid);

          db.collection("users").doc(otherId).get().then(userDoc => {
            const div = document.createElement("div");
            div.innerText = userDoc.data().username;
            div.onclick = () => openChat(otherId, userDoc.data().username);
            chatList.appendChild(div);
          });
        });

      });
  }

  function openChat(uid, username) {
    selectedUser = uid;
    document.getElementById("chatWith").innerText = "Chat with " + username;

    const chatId = getChatId(currentUser.uid, uid);

    if (unsubscribe) unsubscribe();

    unsubscribe = db.collection("chats")
      .doc(chatId)
      .collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {

        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";

        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.classList.add("msg");

          const decrypted = decrypt(msg.text);
          div.innerText = decrypted;

          if (msg.sender === currentUser.uid) {
            div.classList.add("sent");
          } else {
            div.classList.add("received");
          }

          messagesDiv.appendChild(div);
        });

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
  }

  function sendMessage() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text || !selectedUser) return;

    const chatId = getChatId(currentUser.uid, selectedUser);

    db.collection("chats").doc(chatId).set({
      participants: [currentUser.uid, selectedUser]
    }, { merge: true });

    db.collection("chats")
      .doc(chatId)
      .collection("messages")
      .add({
        text: encrypt(text),
        sender: currentUser.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

    input.value = "";
  }
</script>

</body>
</html>
